# This is a GUI for a web scraper that pulls PTR (Periodic Trading Records) from whoever I choose.

import tkinter as tk
from tkinter import ttk 
from tkinter import messagebox
from tkinter import font
import subprocess
import os
import customtkinter
import downloadFile2020 as df20
import downloadFile2021 as df21
import downloadFile2022 as df22
import downloadFile2023 as df23
import house as ho
import pandas as pd
import fileinput
import openai


# OpenAI API key
openai.api_key = "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"

#customtkinter.set_appearance_mode('Dark')
customtkinter.set_default_color_theme('blue')


# window
app = customtkinter.CTk()
app.geometry('720x580')
app.title('CONGRESS WEB SCRAPER')

#
cfont = customtkinter.CTkFont(family='Arial', size=16)
tfont = customtkinter.CTkFont(family='Arial', size=24, weight='bold')

# funciton for year input (excited as i figured this out myself :)
def startdownload():
    try:
        year = year_input.get()
        filename = "downloadFile{}.py".format(year)
        subprocess.call(["python", filename])
        #success
        finishLabel.configure(text='Your files are ready!', text_color='green')
    except:
        #error
        finishLabel.configure(text='There has been an Error!', text_color='red')
    


#function for searching the ptr (house)
def houseparse():
    try:
        year = year_input.get()
        lastname = last_name_var.get()
        textfilename = "{}FD.txt".format(year)
        subprocess.call(["python", 'house.py', textfilename, lastname])

        # Get a list of all .txt files in the current directory
        txt_files = [file for file in os.listdir() if file.endswith(".txt")]

        # Sort the files by their creation time
        txt_files.sort(key=lambda x: os.path.getctime(x), reverse=True)

        if txt_files:
            most_recent_txt_file = txt_files[0]
            with open(most_recent_txt_file, "r") as file:
                file_contents = file.read()

            # Use OpenAI GPT-3 API to generate text based on file_contents
            prompt = f"Give me the first and last names and docids in a table view please. Dont do any kind of explinations just give me exactly what im asking for thank you. Put it in the format like this, Name: , DocID:. so that means literally only give me this: Name: , DocID:   {file_contents}"
            response = openai.ChatCompletion.create (
                model="gpt-4",
                temperature=0,
                messages=[
                    {
                "role": "system",
                "content": "You are a highly skilled AI trained in language comprehension and summarization. I would like you to read the following text and summarize it into a easy to read table."
                    },
                    {
                "role": "user",
                "content": prompt
                    }
                ],
                max_tokens=2000  # Adjust the max_tokens as needed
             )

            generated_summary = response['choices'][0]['message']['content']

            print(generated_summary)
            #success
            finishLabel.configure(text='Success!', text_color='green')
            output_label.configure(text=generated_summary, justify="center")
    except subprocess.CalledProcessError as e:
        print("Error:", e)
        # Handle the error
    except Exception as e:
        print("An error occurred:", str(e))
        # Handle other exceptions


#title
title = customtkinter.CTkLabel(app, text='CONGRESS PTR WEB SCRAPER', font=tfont)
title.pack(padx=10, pady=25)

#year text
year_title = customtkinter.CTkLabel(app, text='Insert a year', font=cfont)
year_title.pack(padx=10, pady=10)

#input for the year
year_var = tk.StringVar()
year_input = customtkinter.CTkEntry(app, width=300, height=40, textvariable=year_var)
year_input.pack()

# download button
download = customtkinter.CTkButton(app, text="Download", command=startdownload)
download.pack(padx=10, pady=10)

#year text
last_name_title = customtkinter.CTkLabel(app, text='Insert a last name', font=cfont)
last_name_title.pack(padx=10, pady=10)

#input for the last name
last_name_var = tk.StringVar()
last_name_input = customtkinter.CTkEntry(app, width=300, height=40, textvariable=last_name_var)
last_name_input.pack()

# find button
find = customtkinter.CTkButton(app, text="Find", command=houseparse)
find.pack(padx=10, pady=10)


# Finished Downloading
finishLabel = customtkinter.CTkLabel(app, text='')
finishLabel.pack()

#custom data
output_label = customtkinter.CTkLabel(app, text='', wraplength=500, font=cfont)
output_label.place(relx=0.5, rely=0.8, anchor="center")

# instructions
usage_label_1 = customtkinter.CTkLabel(app, text='Step 1. Enter a year of your choosing and press Download.', wraplength=100)
usage_label_1.place(relx=0.20, rely=0.18, anchor="ne")

usage_label_2 = customtkinter.CTkLabel(app, text='Step 2. Enter a Last Name of a Politician you are curious about. Ex: Banks, Thanedar and the press Find.', wraplength=100)
usage_label_2.place(relx=0.20, rely=0.40, anchor="ne")

steps = customtkinter.CTkLabel(app, text='Once you get your results, go to google and search the FIRST AND LAST name AND the DOCID. The first link should be the financial report!', wraplength=100)
steps.place(relx=0.80, rely=0.18, anchor="nw")

ex_1 = customtkinter.CTkLabel(app, text='For example, Robert Aderholt 10053968', wraplength=100)
ex_1.place(relx=0.80, rely=0.50, anchor="nw")
#======================

#Light and Dark Mode
def switch_event():
    #customtkinter.set_appearance_mode(color_mode)
    customtkinter.set_appearance_mode(switch.get())
    print("switch toggled, current value:", switch.get())

switch_var = customtkinter.StringVar(value="")
switch = customtkinter.CTkSwitch(app, text="Color Mode", command=switch_event,
variable=switch_var, onvalue="Dark", offvalue="Light")
switch.pack()
#=======================
color_mode = switch.get() 
#=============================


# run loop
app.mainloop()

